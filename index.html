<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ツムツム効率計算（フルリファイン版）</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body {
      font-family: 'Segoe UI', 'Yu Gothic', 'Meiryo', sans-serif;
      background: #eef1f7;
      margin: 0; padding: 0;
      color: #222;
    }
    h1 {
      font-size: 1.5em;
      letter-spacing: 0.03em;
      text-align: center;
      margin: 1.2em 0 0.5em 0;
      font-weight: 700;
    }
    .container {
      max-width: 730px;
      margin: 0 auto;
      padding: 2em 0 3em 0;
    }
    .tabs {
      display: flex; 
      justify-content: center;
      background: #e3eaf5;
      border-radius: 18px 18px 0 0;
      margin-bottom: 0.7em;
      overflow: hidden;
      box-shadow: 0 2px 6px #0001;
    }
    .tab-btn {
      border: none; background: none;
      padding: 0.8em 2.2em;
      font-size: 1em; font-weight:600;
      color: #789;
      background: #e3eaf5;
      cursor: pointer;
      outline: none;
      transition: background 0.2s, color 0.2s;
      white-space:nowrap;
    }
    .tab-btn.active {
      background: #fff;
      color: #1839aa;
      border-bottom: 2px solid #fff;
      box-shadow: 0 2px 6px #0001;
      z-index:2;
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 18px #0002;
      margin-bottom: 1.5em;
      padding: 1.5em 1.2em 1em 1.2em;
    }
    .row { display: flex; align-items: center; gap: 1em; margin-bottom:1em;}
    .row label { font-weight: 500;}
    select, input[type="number"], input[type="text"] {
      padding: 0.45em 0.7em;
      border: 1px solid #c6cbe7;
      border-radius: 8px;
      font-size: 1em;
      margin-left: 0.3em;
      margin-right: 0.3em;
      background: #f7faff;
      transition: border 0.2s;
    }
    select:focus, input:focus {
      outline: none;
      border-color: #3066c7;
      background: #e3eaf5;
    }
    .items, .itemset, .edit-items {
      display: flex;
      align-items: center;
      gap: 0.8em;
      flex-wrap:wrap;
    }
    .items label, .itemset label, .edit-items label {
      margin: 0;
      font-size: 0.97em;
      font-weight: 400;
      letter-spacing: 0.01em;
      display: flex;
      align-items: center;
      gap: 0.23em;
      white-space: nowrap;
    }
    .edit-items input[type=checkbox] {
      accent-color: #396bdb;
      width: 1.1em;
      height: 1.1em;
    }
    button, .btn {
      background: linear-gradient(90deg, #396bdb 60%, #4d8ac5 100%);
      color: #fff;
      border: none;
      padding: 0.6em 1.5em;
      margin-top: 0.2em;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      box-shadow: 0 2px 6px #396bdb33;
      font-weight: 600;
      transition: background 0.18s, transform 0.13s;
      white-space: nowrap;
      min-width: 86px;
      text-align:center;
    }
    button:active, .btn:active { transform: scale(0.98);}
    .danger {background: #e53939;}
    .danger:active{background:#be2626;}
    .stopwatch { margin-bottom: 0.6em; gap: 0.55em; }
    .stopwatch .btn {min-width: 90px;}
    .play-list table, .ranking table, .tsum-admin-table {
      border-collapse: collapse;
      width: 100%;
      background: #f9fafe;
      border-radius: 10px;
      overflow: hidden;
      margin:0;
      border: 1.2px solid #a3b3d3;
      box-shadow: 0 1.5px 8px #1839aa18;
    }
    .play-list th, .play-list td,
    .ranking th, .ranking td,
    .tsum-admin-table th, .tsum-admin-table td {
      border: 1px solid #a3b3d3;
      padding: 0.4em 0.3em;
      text-align: center;
      font-size: 1em;
      min-width: 44px;
    }
    .play-list th, .ranking th, .tsum-admin-table th {
      background: #e3eaf5;
      font-weight: 700;
    }
    .result-summary {
      margin-bottom:0.5em;
      padding: 0.6em 1em;
      background: linear-gradient(90deg,#dbe6fd 80%,#e4ebf7 100%);
      border-radius: 10px;
      font-size: 1.09em;
      color: #222e52;
      font-weight: 600;
      box-shadow:0 2px 8px #1839aa18;
      display: flex; flex-wrap: wrap; gap:1.1em;
    }
    .ranking th, .ranking td { padding:0.3em 0.7em; }
    .center {text-align:center;}
    .tsum-admin-table td button { color: #e53939; font-weight: bold;}
    .tsum-admin-table label {cursor:pointer;}
    .tsum-admin-table input[type=checkbox] { accent-color: #396bdb; }
    @media (max-width:600px){
      .container {padding:0.2em;}
      .row, .result-summary{flex-direction:column; gap:0.4em;}
      .play-list th, .play-list td, .ranking th, .ranking td {font-size:0.91em;}
      .card {padding:1.1em 0.5em;}
      .stopwatch {flex-direction:column;}
      .play-list table, .ranking table, .tsum-admin-table {font-size:0.91em;}
    }
  </style>
</head>
<body>
  <h1>ツムツム効率計算</h1>
  <div class="container">
    <div class="tabs">
      <button class="tab-btn active" onclick="showTab(0)">記録</button>
      <button class="tab-btn" onclick="showTab(2)">ランキング</button>
      <button class="tab-btn" onclick="showTab(1)">管理</button>
    </div>

    <!-- 記録タブ -->
    <div class="tab-content active">
      <div class="card">
        <div class="row">
          <label>+coinアイテム倍率:
            <input type="number" step="0.01" id="itemRate" value="1.3" style="width: 70px;">
          </label>
          <label>ツムを選択:
            <select id="tsumSelect" onchange="onSelectTsum()" style="width:120px;"></select>
          </label>
          <span id="playCountInfo" style="font-size:0.99em; color:#355;">（記録件数：<span id="playCount">0</span>）</span>
        </div>
        <div id="result" class="result-summary"></div>
        <div class="stopwatch row">
          <button onclick="startPlay()" class="btn" id="startBtn">スタート</button>
          <button onclick="stopPlay()" id="stopBtn" class="btn" disabled>ストップ</button>
          <span id="timer" style="font-size:1.09em;letter-spacing:0.06em;">00:00.0</span>
          <label>今回コイン数: 
            <input type="number" id="coinInput" value="0" min="0" style="width:80px;">
          </label>
          <span class="items">
            <label><input type="checkbox" id="itemTime">タイム</label>
            <label><input type="checkbox" id="item54">5→4</label>
            <label><input type="checkbox" id="itemCoin">コイン</label>
          </span>
          <button onclick="addPlay()" id="addBtn" class="btn" disabled>記録追加</button>
        </div>
        <div class="play-list">
          <table>
            <thead>
              <tr>
                <th>#</th><th>ツム</th><th>コイン数</th>
                <th>タイム</th><th>5→4</th><th>コイン</th>
                <th>プレイ時間（秒）</th><th>削除</th>
              </tr>
            </thead>
            <tbody id="plays"></tbody>
          </table>
          <button onclick="resetPlays()" class="btn danger" style="margin-top:0.5em;">全記録クリア</button>
        </div>
      </div>
    </div>

    <!-- 管理タブ -->
    <div class="tab-content">
      <div class="card">
        <h2 style="font-size:1.13em;">ツムの管理</h2>
        <div class="row">
          <label>ツム名:
            <input type="text" id="tsumInput" placeholder="ツム名を入力">
          </label>
          <span class="itemset">
            <label><input type="checkbox" id="setTime">タイム</label>
            <label><input type="checkbox" id="set54">5→4</label>
            <label><input type="checkbox" id="setCoin">コイン</label>
          </span>
          <button onclick="addTsum()" class="btn">追加</button>
        </div>
        <div id="tsumList"></div>
      </div>
    </div>

    <!-- ランキングタブ -->
    <div class="tab-content">
      <div class="card">
        <h2 style="font-size:1.13em;">効率ランキング</h2>
        <div id="rankingArea" class="center"></div>
      </div>
    </div>
  </div>
  <script>
    // タブ切替
    function showTab(idx) {
      const tabs = document.querySelectorAll('.tab-content');
      const btns = document.querySelectorAll('.tab-btn');
      tabs.forEach((t,i)=>t.classList.toggle('active',i===idx));
      btns.forEach((b,i)=>b.classList.toggle('active',i===idx));
      if(idx===2) updateRanking();
      if(idx===0) updateTable();
    }

    // ツム名と基本アイテム
    let tsumData = JSON.parse(localStorage.getItem('tsumData') || '[{"name":"ミッキー","time":false,"f54":false,"coin":false},{"name":"エルサ","time":false,"f54":true,"coin":false}]');
    function saveTsums(){ localStorage.setItem('tsumData', JSON.stringify(tsumData)); }
    function renderTsumList() {
      if(tsumData.length === 0) {
        document.getElementById('tsumList').innerHTML = '<i>登録なし</i>';
        return;
      }
      // 表形式
      let html = `<table class="tsum-admin-table"><thead><tr>
        <th>ツム名</th>
        <th>タイム</th>
        <th>5→4</th>
        <th>コイン</th>
        <th>削除</th>
      </tr></thead><tbody>`;
      tsumData.forEach((t,i)=>{
        html += `<tr>
          <td>${t.name}</td>
          <td><label><input type="checkbox" ${t.time?'checked':''} onchange="editTsumItem(${i},'time',this.checked)"></label></td>
          <td><label><input type="checkbox" ${t.f54?'checked':''} onchange="editTsumItem(${i},'f54',this.checked)"></label></td>
          <td><label><input type="checkbox" ${t.coin?'checked':''} onchange="editTsumItem(${i},'coin',this.checked)"></label></td>
          <td><button onclick="removeTsum(${i})">×</button></td>
        </tr>`;
      });
      html += "</tbody></table>";
      document.getElementById('tsumList').innerHTML = html;
    }
    function renderTsumSelect() {
      const select = document.getElementById('tsumSelect');
      select.innerHTML = tsumData.length === 0
        ? '<option value="">--登録してください--</option>'
        : tsumData.map((t,i) => `<option value="${i}">${t.name}</option>`).join('');
    }
    function addTsum() {
      const val = document.getElementById('tsumInput').value.trim();
      if(val && !tsumData.some(t=>t.name===val)){
        tsumData.push({
          name: val,
          time: document.getElementById('setTime').checked,
          f54: document.getElementById('set54').checked,
          coin: document.getElementById('setCoin').checked
        });
        document.getElementById('tsumInput').value = "";
        document.getElementById('setTime').checked = false;
        document.getElementById('set54').checked = false;
        document.getElementById('setCoin').checked = false;
        saveTsums();
        renderTsumList();
        renderTsumSelect();
      }
    }
    function removeTsum(i){
      tsumData.splice(i,1);
      saveTsums();
      renderTsumList();
      renderTsumSelect();
    }
    function editTsumItem(idx, key, val) {
      tsumData[idx][key] = val;
      saveTsums();
      renderTsumList();
      renderTsumSelect();
    }
    function onSelectTsum() {
      const idx = document.getElementById('tsumSelect').value;
      if(tsumData[idx]){
        document.getElementById('itemTime').checked = tsumData[idx].time;
        document.getElementById('item54').checked  = tsumData[idx].f54;
        document.getElementById('itemCoin').checked= tsumData[idx].coin;
      } else {
        document.getElementById('itemTime').checked = false;
        document.getElementById('item54').checked  = false;
        document.getElementById('itemCoin').checked= false;
      }
      updateTable();
    }

    // プレイ記録の保存・復元
    function loadPlays(){
      return JSON.parse(localStorage.getItem('tsumPlays') || "[]");
    }
    function savePlays(){
      localStorage.setItem('tsumPlays', JSON.stringify(plays));
    }
    function resetPlays(){
      if(confirm("すべての記録を削除します。よろしいですか？")){
        plays.length = 0;
        savePlays();
        updateTable();
      }
    }

    // ストップウォッチ用変数
    let startTime, timerInterval;
    let elapsed = 0;
    let timerRunning = false;

    // プレイ記録
    const plays = loadPlays();

    function formatTime(ms) {
      const s = Math.floor(ms/1000);
      const m = Math.floor(s/60);
      const sec = s%60;
      const ms1 = Math.floor((ms%1000)/100);
      return `${String(m).padStart(2,0)}:${String(sec).padStart(2,0)}.${ms1}`;
    }

    function startPlay() {
      if(tsumData.length === 0){
        alert('ツム名を登録してください');
        return;
      }
      document.getElementById('stopBtn').disabled = false;
      document.getElementById('addBtn').disabled = true;
      document.getElementById('startBtn').disabled = true;
      startTime = Date.now();
      elapsed = 0;
      timerRunning = true;
      document.getElementById('timer').textContent = "00:00.0";
      if(timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if(timerRunning){
          elapsed = Date.now() - startTime;
          document.getElementById('timer').textContent = formatTime(elapsed);
        }
      }, 100);
    }

    function stopPlay() {
      timerRunning = false;
      clearInterval(timerInterval);
      document.getElementById('stopBtn').disabled = true;
      document.getElementById('addBtn').disabled = false;
      document.getElementById('startBtn').disabled = false;
    }

    function addPlay() {
      const tsumIdx = document.getElementById('tsumSelect').value;
      if(tsumIdx==="" || !tsumData[tsumIdx]){ alert('ツムを選択してください'); return; }
      const tsum = tsumData[tsumIdx].name;
      const coins = Number(document.getElementById('coinInput').value);
      const playSec = elapsed / 1000;
      const timeUsed = document.getElementById('itemTime').checked;
      const used54 = document.getElementById('item54').checked;
      const usedCoin = document.getElementById('itemCoin').checked;
      plays.push({tsum, coins, playSec, timeUsed, used54, usedCoin});
      savePlays();
      updateTable();
      document.getElementById('addBtn').disabled = true;
      document.getElementById('timer').textContent = "00:00.0";
      document.getElementById('coinInput').value = 0;
      document.getElementById('itemTime').checked = tsumData[tsumIdx].time;
      document.getElementById('item54').checked  = tsumData[tsumIdx].f54;
      document.getElementById('itemCoin').checked= tsumData[tsumIdx].coin;
      document.getElementById('startBtn').disabled = false;
    }

    function deletePlay(i){
      plays.splice(i,1);
      savePlays();
      updateTable();
    }

    function updateTable() {
      // 現在のツムのみ表示
      const tsumIdx = document.getElementById('tsumSelect').value;
      const curTsum = tsumData[tsumIdx] ? tsumData[tsumIdx].name : null;
      const tbody = document.getElementById('plays');
      const playCountEl = document.getElementById('playCount');
      let filtered = plays;
      if(curTsum) {
        filtered = plays.filter(p=>p.tsum===curTsum);
      }
      // 記録テーブル
      tbody.innerHTML = '';
      filtered.forEach((p,i) => {
        tbody.innerHTML += `<tr>
          <td>${i+1}</td>
          <td>${p.tsum}</td>
          <td>${p.coins}</td>
          <td>${p.timeUsed ? '✓' : ''}</td>
          <td>${p.used54 ? '✓' : ''}</td>
          <td>${p.usedCoin ? '✓' : ''}</td>
          <td>${p.playSec.toFixed(1)}</td>
          <td><button onclick="deletePlay(${plays.indexOf(p)})" style="color:#e53939;font-weight:bold;">×</button></td>
        </tr>`;
      });
      playCountEl.textContent = filtered.length;

      // 集計もフィルタ反映
      showResult(filtered);
    }

    function showResult(filteredPlays = null) {
      // デフォルトは現在のツムのみ
      const tsumIdx = document.getElementById('tsumSelect').value;
      const curTsum = tsumData[tsumIdx] ? tsumData[tsumIdx].name : null;
      const playsTarget = filteredPlays || (curTsum ? plays.filter(p=>p.tsum===curTsum) : []);
      const itemRate = Number(document.getElementById('itemRate').value) || 1;
      const resultDiv = document.getElementById('result');

      if(playsTarget.length === 0) {
        resultDiv.innerHTML = "<span style='color:#888'>このツムの記録がありません。</span>";
        return;
      }
      const sumCoins = playsTarget.reduce((a,b)=>a+b.coins,0);
      const sumSec = playsTarget.reduce((a,b)=>a+b.playSec,0);

      let itemCost = 0;
      playsTarget.forEach(p => {
        if(p.timeUsed) itemCost += 1000;
        if(p.used54) itemCost += 1800;
        if(p.usedCoin) itemCost += 500;
      });

      const bonusCoins = sumCoins * itemRate;
      const netCoins = bonusCoins - itemCost;
      const totalMin = sumSec / 60;
      const perMin = netCoins / totalMin;
      const per30Min = perMin * 30;

      resultDiv.innerHTML =
        `<span><b>総コイン:</b> ${sumCoins.toLocaleString()}枚</span>
         <span><b>倍率後:</b> ${bonusCoins.toLocaleString()}枚</span>
         <span><b>アイテムコスト:</b> -${itemCost.toLocaleString()}枚</span>
         <span><b>プレイ時間:</b> ${totalMin.toFixed(1)}分</span>
         <span><b>1分効率:</b> ${perMin.toFixed(1)}枚</span>
         <span><b>30分効率:</b> ${per30Min.toFixed(1)}枚</span>`;
    }

    // --- ランキング集計 ---
    function updateRanking(){
      if(plays.length === 0){
        document.getElementById('rankingArea').innerHTML = "記録がありません。";
        return;
      }
      const itemRate = Number(document.getElementById('itemRate').value) || 1;
      let tsumMap = {};
      plays.forEach(p => {
        if(!tsumMap[p.tsum]) tsumMap[p.tsum]={sum:0, sec:0, cost:0, cnt:0};
        tsumMap[p.tsum].sum += p.coins;
        tsumMap[p.tsum].sec += p.playSec;
        tsumMap[p.tsum].cnt++;
        if(p.timeUsed) tsumMap[p.tsum].cost += 1000;
        if(p.used54) tsumMap[p.tsum].cost += 1800;
        if(p.usedCoin) tsumMap[p.tsum].cost += 500;
      });
      let tsumArray = [];
      for(const [name,obj] of Object.entries(tsumMap)){
        const bonus = obj.sum * itemRate;
        const netCoins = bonus - obj.cost;
        const min = obj.sec/60;
        const perMin = netCoins/min;
        tsumArray.push({
          tsum: name,
          count: obj.cnt,
          perMin: perMin,
          per30: perMin*30,
          net: netCoins,
          min: min
        });
      }
      tsumArray.sort((a,b)=>b.perMin-a.perMin);

      let html = `
      <table class="ranking">
        <thead><tr>
          <th>順位</th><th>ツム</th><th>回数</th>
          <th>総時間(分)</th>
          <th>1分効率</th>
          <th>30分効率</th>
          <th>総コイン</th>
        </tr></thead>
        <tbody>
      `;
      tsumArray.forEach((r,i)=>{
        html += `<tr>
          <td>${i+1}</td>
          <td>${r.tsum}</td>
          <td>${r.count}</td>
          <td>${r.min.toFixed(1)}</td>
          <td>${r.perMin.toFixed(1)}</td>
          <td>${r.per30.toFixed(1)}</td>
          <td>${r.net.toLocaleString()}</td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById('rankingArea').innerHTML = html;
    }

    // 初期描画
    renderTsumList();
    renderTsumSelect();
    updateTable();
  </script>
</body>
</html>
